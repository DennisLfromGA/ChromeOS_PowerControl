#!/bin/bash
RED=$(tput setaf 1)
GREEN=$(tput setaf 2)
YELLOW=$(tput setaf 3)
BLUE=$(tput setaf 4)
MAGENTA=$(tput setaf 5)
CYAN=$(tput setaf 6)
BOLD=$(tput bold)
RESET=$(tput sgr0)
INSTALL_DIR_FILE="/usr/local/bin/.ChromeOS_PowerControl.install_dir"
if [ -f "$INSTALL_DIR_FILE" ]; then
    INSTALL_DIR=$(cat "$INSTALL_DIR_FILE")
else
    INSTALL_DIR="/usr/local/bin/ChromeOS_PowerControl"
fi
INSTALL_DIR="${INSTALL_DIR%/}"

CONFIG_FILE="$INSTALL_DIR/config.sh"

# Helper: Display current GPU frequency (where supported)
get_current_freq() {
    case "$GPU_TYPE" in
        intel)
            if [[ -f "$GPU_FREQ_PATH" ]]; then
                cat "$GPU_FREQ_PATH"
            else
                echo "Unavailable"
            fi
            ;;
        amd)
            # Show currently active DPM level (approx)
            if [[ -f "$GPU_FREQ_PATH" ]]; then
                cat "$GPU_FREQ_PATH" | grep '*' | awk '{print $2}'
            else
                echo "Unavailable"
            fi
            ;;
        mali|adreno)
            if [[ -f "$GPU_FREQ_PATH" ]]; then
                cat "$GPU_FREQ_PATH"
            else
                echo "Unavailable"
            fi
            ;;
        *)
            echo "Unsupported"
            ;;
    esac
}

# show GPU info
if [[ $# -eq 0 ]]; then
    echo "GPU Type: $GPU_TYPE"
    echo "Max Frequency (detected): $GPU_MAX_FREQ"
    echo -n "Current Frequency: "
    get_current_freq
    exit 0
fi

# Command: Set max frequency
if [[ "$1" == "max" ]]; then
    if [[ -z "$2" ]]; then
        echo "Usage: gpucontrol max <value_in_MHz_or_kHz>"
        exit 1
    fi

    REQUESTED_FREQ="$2"

    # Convert to kHz
    if [[ "$GPU_TYPE" == "amd" || "$GPU_TYPE" == "mali" || "$GPU_TYPE" == "adreno" ]]; then
        UNIT="kHz"
        REQUESTED_FREQ_KHZ=$REQUESTED_FREQ
        if [[ "$REQUESTED_FREQ" -lt 10000 ]]; then
            # assume input was MHz, convert
            REQUESTED_FREQ_KHZ=$((REQUESTED_FREQ * 1000))
        fi

        if [[ "$REQUESTED_FREQ_KHZ" -gt "$GPU_MAX_FREQ" ]]; then
            echo "Error: Requested frequency ($REQUESTED_FREQ_KHZ kHz) exceeds original maximum ($GPU_MAX_FREQ kHz)."
            exit 1
        fi

        echo "$REQUESTED_FREQ_KHZ" | sudo tee "$GPU_FREQ_PATH"

    elif [[ "$GPU_TYPE" == "intel" ]]; then
        UNIT="MHz"
        if [[ "$REQUESTED_FREQ" -gt "$GPU_MAX_FREQ" ]]; then
            echo "Error: Requested frequency ($REQUESTED_FREQ MHz) exceeds original maximum ($GPU_MAX_FREQ MHz)."
            exit 1
        fi

        echo "$REQUESTED_FREQ" | sudo tee "$GPU_FREQ_PATH"

    else
        echo "Error: GPU type '$GPU_TYPE' not supported for frequency setting."
        exit 1
    fi

    echo "Max GPU frequency set to $REQUESTED_FREQ $UNIT"
    exit 0
fi

echo "  gpucontrol              # Show current GPU status"
echo "  gpucontrol max <value>  # Set max GPU frequency (MHz or kHz depending on GPU type)"
exit 1
