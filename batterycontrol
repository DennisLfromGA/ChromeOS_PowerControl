#!/bin/bash

CONFIG_FILE="$HOME/.batterycontrol_config"
CHARGER_PATH="/sys/class/power_supply/CROS_USBPD_CHARGER0/online"
BATTERY_PATH="/sys/class/power_supply/BAT0/capacity"
RUN_FLAG="$HOME/.batterycontrol_enabled"
TURBO_PATH="/sys/devices/system/cpu/intel_pstate/no_turbo"

DEFAULT_CHARGE_MAX=77
DEFAULT_CHARGE_MIN=74

CHARGE_MAX=
CHARGE_MIN=

load_config() {
    if [ -f "$CONFIG_FILE" ]; then
        source "$CONFIG_FILE"
    else
        CHARGE_MAX=$DEFAULT_CHARGE_MAX
        CHARGE_MIN=$DEFAULT_CHARGE_MIN
    fi
}

save_config() {
    echo "CHARGE_MAX=$CHARGE_MAX" > "$CONFIG_FILE"
    echo "CHARGE_MIN=$CHARGE_MIN" >> "$CONFIG_FILE"
}

set_thresholds() {
    if ! [[ "$1" =~ ^[0-9]+$ && "$2" =~ ^[0-9]+$ ]]; then
        echo "Error: Both thresholds must be integers."
        exit 1
    fi
    if [ "$1" -gt 100 ] || [ "$2" -lt 10 ]; then
        echo "Error: CHARGE_MAX cannot be more than 100, and CHARGE_MIN cannot be less than 10."
        exit 1
    fi
    if [ "$2" -ge "$1" ]; then
        echo "Error: CHARGE_MIN must be less than CHARGE_MAX."
        exit 1
    fi

    echo "Battery Charge Status: MAX=$1, MIN=$2"
    CHARGE_MAX=$1
    CHARGE_MIN=$2
    save_config
}

show_help() {
    echo "Battery Control Script - Available Commands:"
    echo
    echo "  help"
    echo "    Show this help message."
    echo
    echo "  set <MAX> <MIN>"
    echo "    Set battery charge thresholds. Max and Min."
    echo "    Example: sudo batterycontrol set 80 75"
    echo
    echo "  start"
    echo "    Enable and start the BatteryControl monitoring loop."
    echo
    echo "  stop"
    echo "    Disable the BatteryControl monitoring loop."
    echo
    echo "  no_turbo [1|0]"
    echo "    Toggle Intel Turbo Boost (1=disable, 0=enable)."
    echo "    Example: sudo batterycontrol no_turbo 1"
    echo
    echo "  uninstall"
    echo "    Launch the uninstaller for ChromeOS_BatteryControl."
    echo
    echo "  status"
    echo "    Show BatteryControl status."
    echo
}

show_status() {
    echo "BatteryControl Status:"

    if [ -f "$RUN_FLAG" ]; then
        echo "  BatteryControl is: ENABLED"
    else
        echo "  BatteryControl is: DISABLED"
    fi

    load_config
    echo "  CHARGE_MAX: $CHARGE_MAX"
    echo "  CHARGE_MIN: $CHARGE_MIN"

    if [ -f "$TURBO_PATH" ]; then
        TURBO_STATUS=$(cat "$TURBO_PATH")
        if [ "$TURBO_STATUS" -eq 1 ]; then
            echo "  Intel Turbo Boost: DISABLED (no_turbo = 1)"
        else
            echo "  Intel Turbo Boost: ENABLED (no_turbo = 0)"
        fi
    else
        echo "  Intel Turbo Boost status: Not available"
    fi
}

# --- Command dispatcher ---
case "$1" in
    set)
        set_thresholds "$2" "$3"
        exit 0
        ;;
    start)
        touch "$RUN_FLAG"
        echo "BatteryControl enabled."
        echo "Starting BatteryControl monitoring loop..."
        load_config
        while true; do
            if [ ! -f "$RUN_FLAG" ]; then
                echo "BatteryControl disabled, exiting monitoring loop."
                exit 0
            fi

            if [ -f "$BATTERY_PATH" ]; then
                CHARGE=$(cat "$BATTERY_PATH" 2>/dev/null)
            else
                sleep 120
                continue
            fi

            if [ -f "$CHARGER_PATH" ]; then
                AC_ON=$(cat "$CHARGER_PATH" 2>/dev/null)
            else
                sleep 120
                continue
            fi

            if [ "$AC_ON" -eq 1 ]; then
                if [ "$CHARGE" -ge "$CHARGE_MAX" ]; then
                    sudo ectool chargecontrol idle >/dev/null 2>&1
                elif [ "$CHARGE" -le "$CHARGE_MIN" ]; then
                    sudo ectool chargecontrol normal >/dev/null 2>&1
                fi
            else
                sudo ectool chargecontrol normal >/dev/null 2>&1
            fi

            sleep 120
        done
        ;;
    stop)
        rm -f "$RUN_FLAG"
        echo "BatteryControl disabled."
        echo "BatteryControl monitoring loop will stop shortly."
        exit 0
        ;;
    no_turbo)
        if [[ "$2" != "0" && "$2" != "1" ]]; then
            echo "Usage: $0 no_turbo [1|0]"
            exit 1
        fi
        if [ -w "$TURBO_PATH" ]; then
            echo "$2" | sudo tee "$TURBO_PATH" > /dev/null
            echo "Turbo Boost is now set to: $2"
        else
            echo "Permission denied or Turbo Boost control not available."
            exit 1
        fi
        exit 0
        ;;
    uninstall)
        if [ -x "/usr/local/bin/ChromeOS_BatteryControl/Uninstall_ChromeOS_BatteryControl.sh" ]; then
            sudo bash /usr/local/bin/ChromeOS_BatteryControl/Uninstall_ChromeOS_BatteryControl.sh
        else
            echo "Uninstall script not found or not executable."
            exit 1
        fi
        exit 0
        ;;
    help | --help | -h)
        show_help
        exit 0
        ;;
    status)
        show_status
        exit 0
        ;;
    "")
        show_status
        echo "Run 'batterycontrol start' to enable monitoring, or 'batterycontrol stop' to disable."
        exit 0
        ;;
    *)
        echo "Unknown command: $1"
        echo "Use '$0 help' to see available commands."
        exit 1
        ;;
esac
