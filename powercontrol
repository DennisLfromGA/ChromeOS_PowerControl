#!/bin/bash

CONFIG_FILE="$HOME/.powercontrol_config"
RUN_FLAG="$HOME/.powercontrol_enabled"
PID_FILE="$HOME/.powercontrol_pid"
PERF_PATH="/sys/devices/system/cpu/intel_pstate/max_perf_pct"
TEMP_SENSOR_ID=2

# Updated default max temp 85°C = 358K
DEFAULT_MAX_TEMP_K=358
DEFAULT_MAX_PERF_PCT=80
MIN_TEMP_K=0           # Go ahead and try it.
MAX_TEMP_LIMIT_K=363   # 90°C max allowed threshold.

MAX_TEMP_K=
MAX_PERF_PCT=

load_config() {
    if [ -f "$CONFIG_FILE" ]; then
        source "$CONFIG_FILE"
    else
        MAX_TEMP_K=$DEFAULT_MAX_TEMP_K
        MAX_PERF_PCT=$DEFAULT_MAX_PERF_PCT
        save_config
    fi
}

save_config() {
    echo "MAX_TEMP_K=$MAX_TEMP_K" > "$CONFIG_FILE"
    echo "MAX_PERF_PCT=$MAX_PERF_PCT" >> "$CONFIG_FILE"
}

set_temp_threshold() {
    if ! [[ "$1" =~ ^[0-9]+$ ]]; then
        echo "Error: Temperature threshold must be an integer (Kelvin)."
        exit 1
    fi
    if (( $1 > MAX_TEMP_LIMIT_K )); then
        echo "Error: Temperature threshold cannot exceed 90°C ($MAX_TEMP_LIMIT_K K)."
        exit 1
    fi
    MAX_TEMP_K=$1
    save_config
    echo "Max temperature threshold set to $MAX_TEMP_K K"
}

start_monitoring_loop() {
    if [ -f "$RUN_FLAG" ]; then
        echo "PowerControl is already running."
        exit 1
    fi

    load_config

    touch "$RUN_FLAG"
    echo $$ > "$PID_FILE"
    echo "Starting PowerControl (PID $$)."

    # State to track if perf cap is currently enforced
    throttled=0

    while [ -f "$RUN_FLAG" ]; do
        temp_k=$(get_temp_kelvin)
        if ! [[ "$temp_k" =~ ^[0-9]+$ ]]; then
            echo "Failed to read temperature sensor $TEMP_SENSOR_ID."
            sleep 1
            continue
        fi

        if (( MAX_TEMP_K <= 0 )); then
            # Temp throttling disabled: always set to max perf pct
            current_pct=$(cat "$PERF_PATH" 2>/dev/null || echo "0")
            if [[ "$current_pct" != "$MAX_PERF_PCT" ]]; then
                echo "Temp throttling disabled -> Setting max_perf_pct to $MAX_PERF_PCT%"
                set_max_perf_pct "$MAX_PERF_PCT"
            fi
            throttled=0
        else
            # Temp throttling enabled
            # Calculate restore threshold: 5K below max temp
            restore_temp_k=$(( MAX_TEMP_K - 5 ))

            current_pct=$(cat "$PERF_PATH" 2>/dev/null || echo "0")

            if (( temp_k >= MAX_TEMP_K )); then
                # Above max temp - enforce throttling (50%)
                if (( throttled == 0 || current_pct != 50 )); then
                    echo "Temperature $temp_k K >= max threshold $MAX_TEMP_K K -> Throttling CPU (50%)"
                    set_max_perf_pct 50
                    throttled=1
                fi
            elif (( temp_k <= restore_temp_k )); then
                # Temp dropped 5K below max - restore max perf pct
                if (( throttled == 1 || current_pct != MAX_PERF_PCT )); then
                    echo "Temperature $temp_k K <= restore threshold $restore_temp_k K -> Restoring max_perf_pct to $MAX_PERF_PCT%"
                    set_max_perf_pct "$MAX_PERF_PCT"
                    throttled=0
                fi
            else
                # Between restore threshold and max threshold: keep current state
                # No action needed here
                :
            fi
        fi

        sleep 1
    done

    echo "PowerControl stopped."
    rm -f "$PID_FILE"
}
